<div class="row g-4">
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="h5 mb-3">
          <% if (selectedDeclaracao) { %>
          Editar Declaração
          <% } else { %>
          Nova Declaração
          <% } %>
        </h2>
        <% if (!currentUser.isMaster) { %>
        <div class="alert alert-warning" role="alert">
          Apenas usuários master podem cadastrar ou editar declarações.
        </div>
        <% } else { %>
        <form
          action="<%= selectedDeclaracao ? '/declaracoes/' + selectedDeclaracao.id + '?_method=PUT' : '/declaracoes' %>"
          method="POST"
        >
          <div class="mb-3">
            <label for="escritura_select" class="form-label">Tipo de Escritura</label>
            <select
              class="form-select"
              id="escritura_select"
              name="escritura_id"
              onchange="window.location.href='/declaracoes?escrituraId=' + this.value;"
            >
              <option value="">Selecione</option>
              <% escrituras.forEach((escritura) => { %>
              <option value="<%= escritura.id %>" <%= Number(selectedEscritura) === escritura.id ? 'selected' : '' %>>
                <%= escritura.nome %>
              </option>
              <% }); %>
            </select>
          </div>
          <div class="mb-3">
            <label for="clausula_id" class="form-label">Cláusula</label>
            <select class="form-select" id="clausula_id" name="clausula_id" required>
              <option value="" disabled <%= selectedClausula ? '' : 'selected' %>>Selecione</option>
              <% clausulas.forEach((clausula) => { %>
              <option
                value="<%= clausula.id %>"
                <%= (selectedDeclaracao && selectedDeclaracao.clausula_id === clausula.id) ||
                (!selectedDeclaracao && Number(selectedClausula) === clausula.id)
                  ? 'selected'
                  : '' %>
              >
                <%= clausula.nome %>
              </option>
              <% }); %>
            </select>
          </div>
          <div class="mb-3">
            <label for="titulo" class="form-label">Título da Declaração</label>
            <input
              type="text"
              class="form-control"
              id="titulo"
              name="titulo"
              value="<%= selectedDeclaracao ? selectedDeclaracao.titulo : '' %>"
              maxlength="255"
              required
            />
          </div>
          <div class="mb-3">
            <label for="texto" class="form-label">Texto da Declaração</label>
            <textarea
              class="form-control"
              id="texto"
              name="texto"
              rows="6"
              required
            ><%= selectedDeclaracao ? selectedDeclaracao.texto : '' %></textarea>
          </div>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
              <%= selectedDeclaracao ? 'Atualizar' : 'Cadastrar' %>
            </button>
            <% if (selectedDeclaracao) { %>
            <a
              class="btn btn-outline-secondary"
              href="/declaracoes?clausulaId=<%= selectedClausula %>&escrituraId=<%= selectedEscritura %>"
            >
              Cancelar
            </a>
            <% } %>
          </div>
        </form>
        <% } %>
        <% if (error) { %>
        <div class="alert alert-danger mt-3" role="alert"><%= error %></div>
        <% } %>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <form class="row g-3 align-items-end mb-4" method="GET" action="/declaracoes">
          <div class="col-12">
            <label for="filtroEscrituraDeclaracao" class="form-label">Tipo de Escritura</label>
            <select
              class="form-select"
              id="filtroEscrituraDeclaracao"
              name="escrituraId"
              onchange="this.form.submit()"
            >
              <option value="">Todas</option>
              <% escrituras.forEach((escritura) => { %>
              <option value="<%= escritura.id %>" <%= Number(selectedEscritura) === escritura.id ? 'selected' : '' %>>
                <%= escritura.nome %>
              </option>
              <% }); %>
            </select>
          </div>
          <div class="col-12">
            <label for="filtroClausula" class="form-label">Cláusula</label>
            <select class="form-select" id="filtroClausula" name="clausulaId" onchange="this.form.submit()">
              <option value="">Todas</option>
              <% clausulas.forEach((clausula) => { %>
              <option value="<%= clausula.id %>" <%= Number(selectedClausula) === clausula.id ? 'selected' : '' %>>
                <%= clausula.nome %>
              </option>
              <% }); %>
            </select>
          </div>
          <% if (selectedEscritura || selectedClausula) { %>
          <div class="col-12">
            <a class="btn btn-outline-secondary" href="/declaracoes">Limpar filtros</a>
          </div>
          <% } %>
        </form>
        <% if (declaracoes.length === 0) { %>
        <p class="text-muted">Nenhuma declaração cadastrada.</p>
        <% } else { %>
        <div class="list-group">
          <% declaracoes.forEach((declaracao) => { %>
          <div class="list-group-item list-group-item-action flex-column align-items-start">
            <div class="d-flex w-100 justify-content-between">
              <h5 class="mb-1"><%= declaracao.titulo || 'Sem título' %></h5>
              <small class="text-muted">Por: <%= declaracao.autor || '—' %></small>
            </div>
            <p class="mb-1 text-muted small">
              Cláusula: <%= declaracao.clausula_nome || 'Cláusula não informada' %>
            </p>
            <p class="mb-1 declaracao-texto"><%= declaracao.texto %></p>
            <small class="text-muted">Escritura: <%= declaracao.escritura_nome || '—' %></small>
            <% if (currentUser.isMaster) { %>
            <div class="mt-3">
              <a
                class="btn btn-sm btn-outline-primary"
                href="/declaracoes/<%= declaracao.id %>/edit?clausulaId=<%= selectedClausula || declaracao.clausula_id %>&escrituraId=<%= selectedEscritura %>"
              >
                Editar
              </a>
              <form
                action="/declaracoes/<%= declaracao.id %>?_method=DELETE"
                method="POST"
                class="d-inline"
                onsubmit="return confirm('Deseja remover esta declaração?');"
              >
                <button type="submit" class="btn btn-sm btn-outline-danger">Excluir</button>
              </form>
            </div>
            <% } %>
          </div>
          <% }); %>
        </div>
        <% } %>
      </div>
    </div>
  </div>
</div>
