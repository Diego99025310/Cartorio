<div class="row g-4 <%= currentUser.isMaster ? '' : 'justify-content-center' %>">
  <% if (currentUser.isMaster) { %>
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="h5 mb-3">
          <% if (editingDeclaracao) { %>
          Editar Declaração
          <% } else { %>
          Nova Declaração
          <% } %>
        </h2>
        <form
          action="<%= editingDeclaracao ? '/declaracoes/' + editingDeclaracao.id + '?_method=PUT' : '/declaracoes' %>"
          method="POST"
        >
          <div class="mb-3">
            <label for="escritura_select" class="form-label">Tipo de Escritura</label>
            <select
              class="form-select"
              id="escritura_select"
              name="escritura_id"
              onchange="window.location.href='/declaracoes?escrituraId=' + this.value;"
            >
              <option value="">Selecione</option>
              <% escrituras.forEach((escritura) => { %>
              <option value="<%= escritura.id %>" <%= Number(selectedEscritura) === escritura.id ? 'selected' : '' %>>
                <%= escritura.nome %>
              </option>
              <% }); %>
            </select>
          </div>
          <div class="mb-3">
            <label for="clausula_id" class="form-label">Cláusula</label>
            <select class="form-select" id="clausula_id" name="clausula_id" required>
              <option value="" disabled <%= selectedClausula ? '' : 'selected' %>>Selecione</option>
              <% clausulas.forEach((clausula) => { %>
              <option
                value="<%= clausula.id %>"
                <%= (editingDeclaracao && editingDeclaracao.clausula_id === clausula.id) ||
                (!editingDeclaracao && Number(selectedClausula) === clausula.id)
                  ? 'selected'
                  : '' %>
              >
                <%= clausula.nome %>
              </option>
              <% }); %>
            </select>
          </div>
          <div class="mb-3">
            <label for="titulo" class="form-label">Título da Declaração</label>
            <input
              type="text"
              class="form-control"
              id="titulo"
              name="titulo"
              value="<%= editingDeclaracao ? editingDeclaracao.titulo : '' %>"
              maxlength="255"
              required
            />
          </div>
          <div class="mb-3">
            <label for="texto" class="form-label">Texto da Declaração</label>
            <textarea
              class="form-control"
              id="texto"
              name="texto"
              rows="6"
              required
            ><%= editingDeclaracao ? editingDeclaracao.texto : '' %></textarea>
          </div>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
              <%= editingDeclaracao ? 'Atualizar' : 'Cadastrar' %>
            </button>
            <% if (editingDeclaracao) { %>
            <a
              class="btn btn-outline-secondary"
              href="/declaracoes?clausulaId=<%= selectedClausula %>&escrituraId=<%= selectedEscritura %><%= selectedDeclaracaoId ? '&declaracaoId=' + selectedDeclaracaoId : '' %>"
            >
              Cancelar
            </a>
            <% } %>
          </div>
        </form>
        <% if (error) { %>
        <div class="alert alert-danger mt-3" role="alert"><%= error %></div>
        <% } %>
      </div>
    </div>
  </div>
  <% } %>
  <div class="<%= currentUser.isMaster ? 'col-12 col-lg-8' : 'col-12 col-lg-10 col-xl-8' %>">
    <div class="card shadow-sm declaracoes-operador-card">
      <div class="card-body">
        <div class="d-flex justify-content-between flex-wrap gap-2 align-items-center mb-4">
          <div>
            <h2 class="h5 mb-1">Declarações cadastradas</h2>
            <p class="text-muted mb-0">Filtre e visualize o texto das declarações existentes.</p>
          </div>
        </div>
        <form class="row g-3 align-items-end mb-4" method="GET" action="/declaracoes">
          <div class="col-12">
            <label for="filtroEscrituraDeclaracao" class="form-label">Tipo de Escritura</label>
            <select
              class="form-select"
              id="filtroEscrituraDeclaracao"
              name="escrituraId"
              onchange="if (this.form.clausulaId) this.form.clausulaId.value=''; if (this.form.declaracaoId) this.form.declaracaoId.value=''; this.form.submit();"
            >
              <option value="">Todas</option>
              <% escrituras.forEach((escritura) => { %>
              <option value="<%= escritura.id %>" <%= Number(selectedEscritura) === escritura.id ? 'selected' : '' %>>
                <%= escritura.nome %>
              </option>
              <% }); %>
            </select>
          </div>
          <div class="col-12">
            <label for="filtroClausula" class="form-label">Cláusula</label>
            <select
              class="form-select"
              id="filtroClausula"
              name="clausulaId"
              onchange="if (this.form.declaracaoId) this.form.declaracaoId.value=''; this.form.submit()"
            >
              <option value="">Todas</option>
              <% clausulas.forEach((clausula) => { %>
              <option value="<%= clausula.id %>" <%= Number(selectedClausula) === clausula.id ? 'selected' : '' %>>
                <%= clausula.nome %>
              </option>
              <% }); %>
            </select>
          </div>
          <% if (declaracoes.length > 0) { %>
          <div class="col-12">
            <label for="filtroDeclaracao" class="form-label">Declaração</label>
            <select
              class="form-select"
              id="filtroDeclaracao"
              name="declaracaoId"
              onchange="this.form.submit()"
            >
              <option value="">Todas</option>
              <% declaracoes.forEach((declaracao) => { %>
              <option
                value="<%= declaracao.id %>"
                <%= Number(selectedDeclaracaoId) === declaracao.id ? 'selected' : '' %>
              >
                <%= declaracao.titulo %>
              </option>
              <% }); %>
            </select>
          </div>
          <% } %>
          <% if (selectedEscritura || selectedClausula) { %>
          <div class="col-12">
            <a class="btn btn-outline-secondary" href="/declaracoes">Limpar filtros</a>
          </div>
          <% } %>
        </form>
        <% if (declaracaoVisualizada) { %>
        <div class="card border-primary mb-4 declaracao-destaque">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
              <div>
                <h5 class="card-title mb-1"><%= declaracaoVisualizada.titulo %></h5>
                <p class="card-subtitle text-muted small mb-0">
                  Escritura: <%= declaracaoVisualizada.escritura_nome || '—' %> · Cláusula:
                  <%= declaracaoVisualizada.clausula_nome || '—' %>
                </p>
              </div>
              <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">
                <span class="badge text-bg-light">
                  Criado por: <%= declaracaoVisualizada.autor || '—' %>
                </span>
                <% if (declaracaoVisualizada.texto) { %>
                <button
                  type="button"
                  class="btn btn-outline-primary btn-sm copy-declaracao"
                  data-copy-target="declaracao-texto-destaque"
                >
                  Copiar declaração
                </button>
                <% } %>
              </div>
            </div>
            <p class="card-text declaracao-texto mt-3" id="declaracao-texto-destaque">
              <%= declaracaoVisualizada.texto %>
            </p>
          </div>
        </div>
        <% } else if (declaracoes.length > 0) { %>
        <p class="text-muted">Selecione uma declaração para visualizar os detalhes.</p>
        <% } %>
        <% if (declaracoes.length === 0) { %>
        <p class="text-muted">Nenhuma declaração cadastrada.</p>
        <% } else { %>
        <div class="list-group">
          <% declaracoes.forEach((declaracao) => { %>
          <div
            class="list-group-item list-group-item-action flex-column align-items-start <%= Number(selectedDeclaracaoId) === declaracao.id ? 'active-declaracao' : '' %>"
          >
            <div class="d-flex w-100 justify-content-between">
              <h5 class="mb-1"><%= declaracao.titulo || 'Sem título' %></h5>
              <small class="text-muted">Por: <%= declaracao.autor || '—' %></small>
            </div>
            <p class="mb-1 text-muted small">
              Cláusula: <%= declaracao.clausula_nome || 'Cláusula não informada' %>
            </p>
            <p class="mb-1 declaracao-texto"><%= declaracao.texto %></p>
            <small class="text-muted">Escritura: <%= declaracao.escritura_nome || '—' %></small>
            <% if (currentUser.isMaster) { %>
            <div class="mt-3">
              <a
                class="btn btn-sm btn-outline-primary"
                href="/declaracoes/<%= declaracao.id %>/edit?clausulaId=<%= selectedClausula || declaracao.clausula_id %>&escrituraId=<%= selectedEscritura %>"
              >
                Editar
              </a>
              <form
                action="/declaracoes/<%= declaracao.id %>?_method=DELETE"
                method="POST"
                class="d-inline"
                onsubmit="return confirm('Deseja remover esta declaração?');"
              >
                <button type="submit" class="btn btn-sm btn-outline-danger">Excluir</button>
              </form>
            </div>
            <% } %>
          </div>
          <% }); %>
        </div>
        <% } %>
      </div>
    </div>
  </div>
</div>
